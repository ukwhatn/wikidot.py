# wikidot.py

> A Python library for interacting with Wikidot sites (SCP Foundation, etc.)

- Version: 4.0.0
- Python: 3.10+
- Dependencies: httpx, beautifulsoup4, lxml
- License: MIT
- Documentation: https://ukwhatn.github.io/wikidot.py/
- Repository: https://github.com/ukwhatn/wikidot.py

## Installation

```bash
pip install wikidot
```

## Basic Usage (Method Chaining)

This library is primarily used with method chaining.

```python
import wikidot

# Without authentication
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")
    print(page.title, page.rating)

# With authentication
with wikidot.Client(username="user", password="pass") as client:
    site = client.site.get("scp-jp")

    # Search pages
    pages = site.pages.search(category="scp", order="rating desc", limit=10)
    for page in pages:
        print(page.fullname, page.rating)

    # Accept all membership applications
    for application in site.applications:
        application.accept()

    # Send PM
    user = client.user.get("target-user")
    client.private_message.send(recipient=user, subject="Subject", body="Body")
```

---

## API Reference

### Client (Entry Point)

```python
with wikidot.Client(username=None, password=None) as client:
    # client.site -> Site operations
    # client.user -> User operations
    # client.private_message -> PM operations
    pass
```

| Chain | Description |
|-------|-------------|
| `client.site.get(unix_name)` | Get site -> Site |
| `client.user.get(name)` | Get user -> User |
| `client.user.get_bulk(names)` | Get multiple users -> UserCollection |
| `client.private_message.inbox` | Inbox -> PrivateMessageInbox |
| `client.private_message.sentbox` | Sent box -> PrivateMessageSentBox |
| `client.private_message.send(recipient, subject, body)` | Send PM |
| `client.private_message.get_message(id)` | Get message |
| `client.is_logged_in` | Login status (bool) |
| `client.me` | Current user |

---

### Site Operations

```python
site = client.site.get("scp-jp")
```

#### Chains from Site

| Chain | Description |
|-------|-------------|
| `site.page.get(fullname)` | Get page -> Page |
| `site.page.create(fullname, title, source, comment)` | Create page -> Page |
| `site.pages.search(**kwargs)` | Search pages -> PageCollection |
| `site.forum.categories` | Forum categories -> ForumCategoryCollection |
| `site.get_thread(thread_id)` | Get thread -> ForumThread |
| `site.get_threads(thread_ids)` | Get multiple threads -> list[ForumThread] |
| `site.members` | Member list -> list[SiteMember] |
| `site.moderators` | Moderator list -> list[SiteMember] |
| `site.admins` | Admin list -> list[SiteMember] |
| `site.member_lookup(user_name)` | Search member -> SiteMember |
| `site.applications` | Membership applications (login required) -> list[SiteApplication] |
| `site.invite_user(user, text)` | Invite user (login required) |
| `site.get_recent_changes(limit)` | Site change history -> list[SiteChange] |

#### Site Properties

| Property | Type | Description |
|----------|------|-------------|
| `site.unix_name` | str | Site identifier |
| `site.name` | str | Site name |
| `site.title` | str | Site title |
| `site.url` | str | Site URL |

---

### Page Operations

```python
# Get
page = site.page.get("scp-173")
page = site.page.get("scp-173", raise_when_not_found=False)  # Returns None if not found

# Search
pages = site.pages.search(
    category="*",           # Category ("*" for all)
    tags=["scp", "euclid"], # Tag filter (use - to exclude: "-tale")
    order="rating desc",    # Sort order
    limit=50                # Number of results
)
```

#### Search Parameters

Parameters inherit from Wikidot's [ListPages module](https://www.wikidot.com/doc-modules:listpages-module).

**Selection**

| Parameter | Description | Example |
|-----------|-------------|---------|
| `pagetype` | Page type | `"*"` (all), `"normal"`, `"hidden"` |
| `category` | Category | `"*"` (all), `"scp"`, `"."` (current) |
| `tags` | Tag filter (space-separated for OR, - for exclude) | `["scp", "euclid"]`, `["scp", "-tale"]` |
| `parent` | Parent page | `"parent-page"`, `"."` (child pages), `"-"` (no parent) |
| `link_to` | Link target page | `"scp-173"` |
| `created_by` | Author | `"username"` or User object |
| `created_at` | Created date | `"2024"`, `"last 7 day"`, `">2024-01-01"` |
| `updated_at` | Updated date | `"last 1 week"`, `"<2024-12-31"` |
| `rating` | Rating value | `">50"`, `">=100"` |
| `votes` | Vote count | `">10"`, `">=5"` |
| `name` | Page name pattern | `"scp-*"`, `"about"` |
| `fullname` | Fullname (exact match) | `"scp:scp-173"` |
| `range` | Range specification | Page range |

**Ordering**

| Parameter | Description | Example |
|-----------|-------------|---------|
| `order` | Sort order (property + desc/asc) | `"created_at desc"` (default), `"rating desc"`, `"name"`, `"updated_at"`, `"size"`, `"random"` |

**Pagination**

| Parameter | Description | Default |
|-----------|-------------|---------|
| `limit` | Maximum number of results | No limit |
| `offset` | Starting position | `0` |
| `perPage` | Results per request | `250` (max 250) |

#### Page Properties

| Property | Type | Description |
|----------|------|-------------|
| `page.id` | int | Page ID |
| `page.fullname` | str | Fullname (category:name) |
| `page.name` | str | Page name |
| `page.category` | str | Category |
| `page.title` | str | Title |
| `page.created_at` | datetime | Created date |
| `page.created_by` | AbstractUser | Author |
| `page.updated_at` | datetime | Updated date |
| `page.updated_by` | AbstractUser | Updater |
| `page.rating` | int | Rating value |
| `page.rating_votes` | int | Vote count |
| `page.tags` | list[str] | Tags |
| `page.source` | PageSource | Source code |
| `page.source.wiki_text` | str | Wikidot syntax source |
| `page.revisions` | PageRevisionCollection | Revision history |
| `page.latest_revision` | PageRevision | Latest revision |
| `page.votes` | PageVoteCollection | Vote list |
| `page.metas` | dict[str, str] | Meta tags |
| `page.discussion` | ForumThread \| None | Discussion thread |
| `page.files` | PageFileCollection | Attached file list |

#### Page Methods (Write)

```python
# Create
page = site.page.create(
    fullname="test:new-page",
    title="New Page",
    source="Page content",
    comment="Creation comment"
)

# Edit
page = page.edit(
    title="New Title",      # None for no change
    source="New content",   # None for no change
    comment="Edit comment"
)

# Delete
page.destroy()

# Tag changes
page.tags.append("new-tag")
page.tags.remove("old-tag")
page.commit_tags()

# Set meta tags
page.metas = {"key": "value"}

# Set parent page
page.set_parent("parent-page")  # Set parent
page.set_parent(None)           # Remove parent

# Rename page
page.rename("new-fullname")

# Vote (login required)
new_rating = page.vote(1)       # +1 vote, returns new rating
new_rating = page.vote(-1)      # -1 vote
new_rating = page.cancel_vote() # Cancel vote
```

#### PageCollection Operations

```python
pages = site.pages.search(category="scp")

# Iteration
for page in pages:
    print(page.title)

# Search
page = pages.find("scp-173")

# Bulk fetch (efficient)
pages.get_page_ids()        # Get all page IDs
pages.get_page_sources()    # Get all page sources
pages.get_page_revisions()  # Get all page revisions
pages.get_page_votes()      # Get all page votes
```

---

### User Operations

```python
user = client.user.get("username")
user = client.user.get("username", raise_when_not_found=False)  # Returns None if not found
users = client.user.get_bulk(["user1", "user2", "user3"])
```

#### User Properties

| Property | Type | Description |
|----------|------|-------------|
| `user.id` | int | User ID |
| `user.name` | str | Username |
| `user.unix_name` | str | Unix-style name |
| `user.avatar_url` | str | Avatar URL |

#### User Types

Users returned by `page.created_by` etc. are one of these types:
- `User` - Regular registered user
- `DeletedUser` - Deleted user
- `AnonymousUser` - Anonymous user
- `GuestUser` - Guest user
- `WikidotUser` - Wikidot system user

---

### SiteMember Operations

```python
# Member list
for member in site.members:
    print(member.user.name, member.joined_at)

# Search specific member
member = site.member_lookup("username")

# Change permissions (login required)
member.to_moderator()      # Promote to moderator
member.remove_moderator()  # Remove moderator
member.to_admin()          # Promote to admin
member.remove_admin()      # Remove admin
```

#### SiteMember Properties

| Property | Type | Description |
|----------|------|-------------|
| `member.site` | Site | Belonging site |
| `member.user` | User | User |
| `member.joined_at` | datetime | Join date |

---

### SiteApplication Operations (Login Required)

```python
# Get and process application list
for application in site.applications:
    print(f"Applicant: {application.user.name}")
    application.accept()   # Accept
    # application.decline()  # Decline
```

---

### Forum Operations

```python
# Category list
categories = site.forum.categories

# Threads in category
category = categories.find(category_id)
for thread in category.threads:
    print(thread.title)

# Get thread
thread = site.get_thread(thread_id)
threads = site.get_threads([id1, id2, id3])

# Create thread
thread = category.create_thread(
    title="Thread Title",
    description="Thread description",
    source="First post content (Wikidot syntax)"
)
```

#### ForumThread Properties

| Property | Type | Description |
|----------|------|-------------|
| `thread.id` | int | Thread ID |
| `thread.title` | str | Title |
| `thread.url` | str | URL |
| `thread.created_at` | datetime | Created date |
| `thread.created_by` | AbstractUser | Author |
| `thread.post_count` | int | Post count |
| `thread.posts` | ForumPostCollection | Post list |

#### ForumThread Methods

```python
# Reply to thread (login required)
thread.reply(source="Reply content")
thread.reply(source="Reply content", title="Title")
thread.reply(source="Reply content", parent_post_id=12345)  # Reply to specific post
```

#### ForumPost Properties

| Property | Type | Description |
|----------|------|-------------|
| `post.id` | int | Post ID |
| `post.title` | str | Title |
| `post.text` | str | Body (HTML) |
| `post.source` | str | Source (Wikidot syntax) |
| `post.created_by` | AbstractUser | Author |
| `post.created_at` | datetime | Post date |
| `post.edited_by` | AbstractUser \| None | Editor |
| `post.edited_at` | datetime \| None | Edit date |
| `post.parent_id` | int \| None | Parent post ID |

#### ForumPost Methods

```python
# Edit post (login required)
post.edit(source="New content")
post.edit(source="New content", title="New title")
```

---

### PageRevision Operations

```python
# Revision list
for revision in page.revisions:
    print(revision.id, revision.created_at, revision.created_by.name)

# Latest revision
latest = page.latest_revision

# Get source
wiki_text = revision.source.wiki_text

# Bulk fetch (efficient)
page.revisions.get_sources()  # Get all revision sources
page.revisions.get_htmls()    # Get all revision HTMLs
```

---

### PageVote Operations

```python
for vote in page.votes:
    print(vote.user.name, vote.value)  # value: +1 or -1

# Search specific user's vote
vote = page.votes.find(user)
```

---

### PageFile Operations

```python
# Page attached files list
for file in page.files:
    print(file.name, file.size, file.mime_type)

# Search specific file
file = page.files.find(file_id)
file = page.files.find_by_name("image.png")
```

#### PageFile Properties

| Property | Type | Description |
|----------|------|-------------|
| `file.id` | int | File ID |
| `file.name` | str | File name |
| `file.url` | str | Download URL |
| `file.mime_type` | str | MIME type |
| `file.size` | int | File size (bytes) |

---

### SiteChange Operations

```python
# Recent change history
changes = site.get_recent_changes(limit=100)

for change in changes:
    print(f"{change.page_fullname} rev.{change.revision_no}")
    print(f"  by {change.changed_by.name} at {change.changed_at}")
    print(f"  flags: {change.flags}, comment: {change.comment}")
```

#### SiteChange Properties

| Property | Type | Description |
|----------|------|-------------|
| `change.page_fullname` | str | Page fullname |
| `change.page_title` | str | Page title |
| `change.revision_no` | int | Revision number |
| `change.changed_by` | AbstractUser | Changed by |
| `change.changed_at` | datetime | Changed at |
| `change.flags` | list[str] | Change flags (N/S/T/R/M/F/A) |
| `change.comment` | str \| None | Change comment |

Change flags: N=New, S=Source changed, T=Title changed, R=Renamed, M=Moved, F=File, A=Deleted

---

### PrivateMessage Operations (Login Required)

```python
# Send PM
user = client.user.get("target-user")
client.private_message.send(
    recipient=user,
    subject="Subject",
    body="Body"
)

# Inbox
for message in client.private_message.inbox:
    print(message.subject, message.sender.name)

# Sent box
for message in client.private_message.sentbox:
    print(message.subject, message.recipient.name)

# Get individual
message = client.private_message.get_message(message_id)
```

#### PrivateMessage Properties

| Property | Type | Description |
|----------|------|-------------|
| `message.id` | int | Message ID |
| `message.subject` | str | Subject |
| `message.body` | str | Body |
| `message.sender` | AbstractUser | Sender |
| `message.recipient` | AbstractUser | Recipient |
| `message.created_at` | datetime | Sent date |

---

## Exception Classes

```
WikidotException                    # Base exception
├── SessionCreateException          # Login failed
├── LoginRequiredException          # Login required
├── NotFoundException               # Resource not found
├── TargetExistsException           # Resource already exists
├── TargetErrorException            # Operation not possible
├── ForbiddenException              # Permission denied
├── NoElementException              # HTML element not found
├── UnexpectedException             # Unexpected error
└── AjaxModuleConnectorException    # API base exception
    ├── AMCHttpStatusCodeException  # HTTP error
    ├── WikidotStatusCodeException  # Wikidot API error
    └── ResponseDataException       # Invalid response
```

```python
from wikidot.common.exceptions import NotFoundException, LoginRequiredException

try:
    page = site.page.get("nonexistent")
except NotFoundException:
    print("Page not found")
```

---

## Code Examples

### Get Page Information

```python
import wikidot

with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")

    print(f"Title: {page.title}")
    print(f"Rating: {page.rating}")
    print(f"Author: {page.created_by.name}")
    print(f"Tags: {page.tags}")
    print(f"Source: {page.source.wiki_text[:100]}...")
```

### Search Pages (Top 10 by Rating)

```python
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    pages = site.pages.search(category="scp", order="rating desc", limit=10)

    for page in pages:
        print(f"{page.fullname}: {page.rating}")
```

### Create, Edit, Delete Page

```python
with wikidot.Client(username="user", password="pass") as client:
    site = client.site.get("sandbox")

    # Create
    page = site.page.create(
        fullname="test:my-page",
        title="Test Page",
        source="This is a test."
    )

    # Edit
    page = page.edit(title="Updated Title", source="Updated content")

    # Change tags
    page.tags.append("test")
    page.commit_tags()

    # Delete
    page.destroy()
```

### Revision History

```python
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")

    for revision in page.revisions:
        print(f"Rev {revision.id}: {revision.created_at} by {revision.created_by.name}")
```

### Create Forum Thread

```python
with wikidot.Client(username="user", password="pass") as client:
    site = client.site.get("scp-jp")
    category = site.forum.categories.find(category_id)

    thread = category.create_thread(
        title="New Thread",
        description="Thread description",
        source="First post content"
    )
    print(f"Created: {thread.url}")
```

### Forum Post Operations

```python
with wikidot.Client(username="user", password="pass") as client:
    site = client.site.get("scp-jp")
    thread = site.get_thread(thread_id)

    # Post list
    for post in thread.posts:
        print(f"{post.title} by {post.created_by.name}")
        print(f"  {post.source[:50]}...")

    # Reply to thread
    thread.reply(source="Reply content", title="Re: Title")

    # Reply to specific post
    thread.reply(source="Reply content", parent_post_id=post.id)

    # Edit post
    post = thread.posts[0]
    post.edit(source="Edited content", title="Edited title")
```

### Member Management

```python
with wikidot.Client(username="admin", password="pass") as client:
    site = client.site.get("my-site")

    # Member list
    for member in site.members:
        print(f"{member.user.name}: {member.joined_at}")

    # Change permissions
    member = site.member_lookup("username")
    member.to_moderator()
```

### Process Applications

```python
with wikidot.Client(username="admin", password="pass") as client:
    site = client.site.get("my-site")

    for application in site.applications:
        print(f"Applicant: {application.user.name}")
        application.accept()
```

### Send PM

```python
with wikidot.Client(username="user", password="pass") as client:
    user = client.user.get("target-user")
    client.private_message.send(
        recipient=user,
        subject="Hello",
        body="This is a message."
    )
```

### Site Change History

```python
with wikidot.Client() as client:
    site = client.site.get("scp-jp")

    # Recent 100 changes
    changes = site.get_recent_changes(limit=100)

    for change in changes:
        flags_str = "".join(change.flags)
        print(f"[{flags_str}] {change.page_fullname} (rev.{change.revision_no})")
        print(f"    by {change.changed_by.name} at {change.changed_at}")
```

### Page Discussion

```python
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")

    # Get discussion thread
    if page.discussion:
        thread = page.discussion
        print(f"Comment count: {thread.post_count}")

        for post in thread.posts:
            print(f"{post.created_by.name}: {post.title}")
```

### Page File List

```python
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")

    # Attached files list
    for file in page.files:
        print(f"{file.name} ({file.size} bytes)")
        print(f"  URL: {file.url}")
        print(f"  Type: {file.mime_type}")
```

---

## Reference Links

- Official Documentation: https://ukwhatn.github.io/wikidot.py/
- GitHub: https://github.com/ukwhatn/wikidot.py
- PyPI: https://pypi.org/project/wikidot/
