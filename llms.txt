# wikidot.py

> Wikidotサイト（SCP Foundation等）と対話するためのPythonライブラリ

- Version: 3.1.0dev13
- Python: 3.10+
- 依存関係: httpx, beautifulsoup4, lxml
- ライセンス: MIT
- ドキュメント: https://ukwhatn.github.io/wikidot.py/
- リポジトリ: https://github.com/ukwhatn/wikidot.py

## インストール

```bash
pip install wikidot
```

## 基本的な使い方（メソッドチェーン）

このライブラリは基本的にメソッドチェーンで利用します。

```python
import wikidot

# 認証なしの場合
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")
    print(page.title, page.rating)

# 認証ありの場合
with wikidot.Client(username="user", password="pass") as client:
    site = client.site.get("scp-jp")

    # ページ検索
    pages = site.pages.search(category="scp", order="rating desc", limit=10)
    for page in pages:
        print(page.fullname, page.rating)

    # 参加申請を全て承認
    for application in site.applications:
        application.accept()

    # PMを送信
    user = client.user.get("target-user")
    client.private_message.send(recipient=user, subject="件名", body="本文")
```

---

## API リファレンス

### Client（エントリポイント）

```python
with wikidot.Client(username=None, password=None) as client:
    # client.site → サイト操作
    # client.user → ユーザー操作
    # client.private_message → PM操作
    pass
```

| チェーン | 説明 |
|---------|------|
| `client.site.get(unix_name)` | サイト取得 → Site |
| `client.user.get(name)` | ユーザー取得 → User |
| `client.user.get_bulk(names)` | 複数ユーザー取得 → UserCollection |
| `client.private_message.inbox` | 受信箱 → PrivateMessageInbox |
| `client.private_message.sentbox` | 送信箱 → PrivateMessageSentBox |
| `client.private_message.send(recipient, subject, body)` | PM送信 |
| `client.private_message.get_message(id)` | メッセージ取得 |
| `client.is_logged_in` | ログイン状態（bool） |
| `client.me` | 現在のユーザー |

---

### Site操作

```python
site = client.site.get("scp-jp")
```

#### Siteからのチェーン

| チェーン | 説明 |
|---------|------|
| `site.page.get(fullname)` | ページ取得 → Page |
| `site.page.create(fullname, title, source, comment)` | ページ作成 → Page |
| `site.pages.search(**kwargs)` | ページ検索 → PageCollection |
| `site.forum.categories` | フォーラムカテゴリ → ForumCategoryCollection |
| `site.get_thread(thread_id)` | スレッド取得 → ForumThread |
| `site.get_threads(thread_ids)` | 複数スレッド取得 → list[ForumThread] |
| `site.members` | メンバー一覧 → list[SiteMember] |
| `site.moderators` | モデレーター一覧 → list[SiteMember] |
| `site.admins` | 管理者一覧 → list[SiteMember] |
| `site.member_lookup(user_name)` | メンバー検索 → SiteMember |
| `site.applications` | 参加申請一覧（要ログイン） → list[SiteApplication] |
| `site.invite_user(user, text)` | ユーザー招待（要ログイン） |

#### Siteプロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `site.unix_name` | str | サイト識別名 |
| `site.name` | str | サイト名 |
| `site.title` | str | サイトタイトル |
| `site.url` | str | サイトURL |

---

### Page操作

```python
# 取得
page = site.page.get("scp-173")
page = site.page.get("scp-173", raise_when_not_found=False)  # 見つからない場合None

# 検索
pages = site.pages.search(
    category="*",           # カテゴリ（"*"で全て）
    tags=["scp", "euclid"], # タグフィルター（-で除外: "-tale"）
    order="rating desc",    # ソート順
    limit=50                # 取得件数
)
```

#### 検索パラメータ一覧

| パラメータ | 説明 | 例 |
|-----------|------|-----|
| `category` | カテゴリ | `"scp"`, `"*"` |
| `tags` | タグフィルター | `["scp", "-tale"]` |
| `parent` | 親ページ | `"parent-page"` |
| `created_by` | 作成者 | `"username"` |
| `created_at` | 作成日時 | `">2024-01-01"` |
| `updated_at` | 更新日時 | `"<2024-12-31"` |
| `rating` | 評価 | `">50"` |
| `votes` | 投票数 | `">10"` |
| `name` | ページ名パターン | `"scp-*"` |
| `order` | ソート順 | `"rating desc"`, `"created_at desc"` |
| `limit` | 取得件数 | `100` |
| `offset` | オフセット | `0` |

#### Pageプロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `page.id` | int | ページID |
| `page.fullname` | str | フルネーム（category:name） |
| `page.name` | str | ページ名 |
| `page.category` | str | カテゴリ |
| `page.title` | str | タイトル |
| `page.created_at` | datetime | 作成日時 |
| `page.created_by` | AbstractUser | 作成者 |
| `page.updated_at` | datetime | 更新日時 |
| `page.updated_by` | AbstractUser | 更新者 |
| `page.rating` | int | 評価値 |
| `page.rating_votes` | int | 投票数 |
| `page.tags` | list[str] | タグ |
| `page.source` | PageSource | ソースコード |
| `page.source.wiki_text` | str | Wikidot記法のソース |
| `page.revisions` | PageRevisionCollection | リビジョン履歴 |
| `page.latest_revision` | PageRevision | 最新リビジョン |
| `page.votes` | PageVoteCollection | 投票一覧 |
| `page.metas` | dict[str, str] | メタタグ |

#### Pageメソッド（書き込み）

```python
# 作成
page = site.page.create(
    fullname="test:new-page",
    title="新しいページ",
    source="ページ内容",
    comment="作成コメント"
)

# 編集
page = page.edit(
    title="新タイトル",     # Noneで変更なし
    source="新内容",        # Noneで変更なし
    comment="編集コメント"
)

# 削除
page.destroy()

# タグ変更
page.tags.append("new-tag")
page.tags.remove("old-tag")
page.commit_tags()

# メタタグ設定
page.metas = {"key": "value"}
```

#### PageCollection操作

```python
pages = site.pages.search(category="scp")

# イテレーション
for page in pages:
    print(page.title)

# 検索
page = pages.find("scp-173")

# 一括取得（効率的）
pages.get_page_ids()        # 全ページのIDを取得
pages.get_page_sources()    # 全ページのソースを取得
pages.get_page_revisions()  # 全ページのリビジョンを取得
pages.get_page_votes()      # 全ページの投票を取得
```

---

### User操作

```python
user = client.user.get("username")
user = client.user.get("username", raise_when_not_found=False)  # 見つからない場合None
users = client.user.get_bulk(["user1", "user2", "user3"])
```

#### Userプロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `user.id` | int | ユーザーID |
| `user.name` | str | ユーザー名 |
| `user.unix_name` | str | Unix形式名 |
| `user.avatar_url` | str | アバターURL |

#### ユーザータイプ

`page.created_by` などで返されるユーザーは以下のいずれかの型:
- `User` - 通常の登録ユーザー
- `DeletedUser` - 削除されたユーザー
- `AnonymousUser` - 匿名ユーザー
- `GuestUser` - ゲストユーザー
- `WikidotUser` - Wikidotシステムユーザー

---

### SiteMember操作

```python
# メンバー一覧
for member in site.members:
    print(member.user.name, member.joined_at)

# 特定メンバー検索
member = site.member_lookup("username")

# 権限変更（要ログイン）
member.to_moderator()      # モデレーター昇格
member.remove_moderator()  # モデレーター解除
member.to_admin()          # 管理者昇格
member.remove_admin()      # 管理者解除
```

#### SiteMemberプロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `member.site` | Site | 所属サイト |
| `member.user` | User | ユーザー |
| `member.joined_at` | datetime | 参加日時 |

---

### SiteApplication操作（要ログイン）

```python
# 申請一覧を取得して処理
for application in site.applications:
    print(f"申請者: {application.user.name}")
    application.accept()   # 承認
    # application.decline()  # 拒否
```

---

### Forum操作

```python
# カテゴリ一覧
categories = site.forum.categories

# カテゴリ内スレッド
category = categories.find(category_id)
for thread in category.threads:
    print(thread.title)

# スレッド取得
thread = site.get_thread(thread_id)
threads = site.get_threads([id1, id2, id3])

# スレッド作成
thread = category.create_thread(
    title="スレッドタイトル",
    description="スレッド説明",
    source="最初の投稿内容（Wikidot記法）"
)
```

#### ForumThreadプロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `thread.id` | int | スレッドID |
| `thread.title` | str | タイトル |
| `thread.url` | str | URL |
| `thread.created_at` | datetime | 作成日時 |
| `thread.created_by` | AbstractUser | 作成者 |
| `thread.posts_count` | int | 投稿数 |

#### ForumPostプロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `post.id` | int | 投稿ID |
| `post.title` | str | タイトル |
| `post.text` | str | 本文（HTML） |
| `post.created_by` | AbstractUser | 投稿者 |
| `post.created_at` | datetime | 投稿日時 |

---

### PageRevision操作

```python
# リビジョン一覧
for revision in page.revisions:
    print(revision.id, revision.created_at, revision.created_by.name)

# 最新リビジョン
latest = page.latest_revision

# ソース取得
wiki_text = revision.source.wiki_text

# 一括取得（効率的）
page.revisions.get_sources()  # 全リビジョンのソースを取得
page.revisions.get_htmls()    # 全リビジョンのHTMLを取得
```

---

### PageVote操作

```python
for vote in page.votes:
    print(vote.user.name, vote.value)  # value: +1 or -1

# 特定ユーザーの投票を検索
vote = page.votes.find(user)
```

---

### PrivateMessage操作（要ログイン）

```python
# PM送信
user = client.user.get("target-user")
client.private_message.send(
    recipient=user,
    subject="件名",
    body="本文"
)

# 受信箱
for message in client.private_message.inbox:
    print(message.subject, message.sender.name)

# 送信箱
for message in client.private_message.sentbox:
    print(message.subject, message.recipient.name)

# 個別取得
message = client.private_message.get_message(message_id)
```

#### PrivateMessageプロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `message.id` | int | メッセージID |
| `message.subject` | str | 件名 |
| `message.body` | str | 本文 |
| `message.sender` | AbstractUser | 送信者 |
| `message.recipient` | AbstractUser | 受信者 |
| `message.created_at` | datetime | 送信日時 |

---

## 例外クラス

```
WikidotException                    # 基底例外
├── SessionCreateException          # ログイン失敗
├── LoginRequiredException          # ログイン必要
├── NotFoundException               # リソース未発見
├── TargetExistsException           # リソース既存
├── TargetErrorException            # 操作不可
├── ForbiddenException              # 権限不足
├── NoElementException              # HTML要素未発見
├── UnexpectedException             # 予期しないエラー
└── AjaxModuleConnectorException    # API基底例外
    ├── AMCHttpStatusCodeException  # HTTPエラー
    ├── WikidotStatusCodeException  # Wikidot APIエラー
    └── ResponseDataException       # レスポンス不正
```

```python
from wikidot.common.exceptions import NotFoundException, LoginRequiredException

try:
    page = site.page.get("nonexistent")
except NotFoundException:
    print("ページが見つかりません")
```

---

## コード例

### ページ情報取得

```python
import wikidot

with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")

    print(f"タイトル: {page.title}")
    print(f"評価: {page.rating}")
    print(f"作成者: {page.created_by.name}")
    print(f"タグ: {page.tags}")
    print(f"ソース: {page.source.wiki_text[:100]}...")
```

### ページ検索（評価順TOP10）

```python
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    pages = site.pages.search(category="scp", order="rating desc", limit=10)

    for page in pages:
        print(f"{page.fullname}: {page.rating}")
```

### ページ作成・編集・削除

```python
with wikidot.Client(username="user", password="pass") as client:
    site = client.site.get("sandbox")

    # 作成
    page = site.page.create(
        fullname="test:my-page",
        title="テストページ",
        source="これはテストです。"
    )

    # 編集
    page = page.edit(title="更新タイトル", source="更新内容")

    # タグ変更
    page.tags.append("test")
    page.commit_tags()

    # 削除
    page.destroy()
```

### リビジョン履歴

```python
with wikidot.Client() as client:
    site = client.site.get("scp-jp")
    page = site.page.get("scp-173")

    for revision in page.revisions:
        print(f"Rev {revision.id}: {revision.created_at} by {revision.created_by.name}")
```

### フォーラムスレッド作成

```python
with wikidot.Client(username="user", password="pass") as client:
    site = client.site.get("scp-jp")
    category = site.forum.categories.find(category_id)

    thread = category.create_thread(
        title="新しいスレッド",
        description="スレッドの説明",
        source="最初の投稿内容"
    )
    print(f"作成: {thread.url}")
```

### メンバー管理

```python
with wikidot.Client(username="admin", password="pass") as client:
    site = client.site.get("my-site")

    # メンバー一覧
    for member in site.members:
        print(f"{member.user.name}: {member.joined_at}")

    # 権限変更
    member = site.member_lookup("username")
    member.to_moderator()
```

### 参加申請処理

```python
with wikidot.Client(username="admin", password="pass") as client:
    site = client.site.get("my-site")

    for application in site.applications:
        print(f"申請者: {application.user.name}")
        application.accept()
```

### PM送信

```python
with wikidot.Client(username="user", password="pass") as client:
    user = client.user.get("target-user")
    client.private_message.send(
        recipient=user,
        subject="こんにちは",
        body="メッセージ本文です。"
    )
```

---

## 参考リンク

- 公式ドキュメント: https://ukwhatn.github.io/wikidot.py/
- GitHub: https://github.com/ukwhatn/wikidot.py
- PyPI: https://pypi.org/project/wikidot/
